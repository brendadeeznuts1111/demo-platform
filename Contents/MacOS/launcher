#!/bin/bash

# @DEMO Enterprise Platform Launcher
# Interactive launcher with multiple server options

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$(dirname "$APP_DIR")"

# Change to project directory
cd "$PROJECT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
WHITE='\033[1;37m'
NC='\033[0m'

# Show main menu
show_menu() {
    clear
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘               ğŸš€ @DEMO ENTERPRISE PLATFORM                   â•‘${NC}"
    echo -e "${CYAN}â•‘         Choose Your Server Configuration                     â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${WHITE}ğŸ¯ Available Servers:${NC}"
    echo ""
    echo -e "${GREEN}  1) ğŸš€ Ultimate Server${NC}    - Full AI + Blockchain + Quantum + AR/VR"
    echo -e "${BLUE}  2) ğŸ¤– Enterprise Server${NC}  - AI Analytics + Advanced Features"
    echo -e "${PURPLE}  3) ğŸ”’ Secure Server${NC}       - Security-Enhanced + Monitoring"
    echo -e "${YELLOW}  4) âš¡ Full Server${NC}         - Complete Feature Set"
    echo -e "${CYAN}  5) ğŸŒŸ Demo Server${NC}          - Lightweight Demo"
    echo ""
    echo -e "${WHITE}ğŸ”§ Utilities:${NC}"
    echo ""
    echo -e "${RED}  6) ğŸ§ª Run All Tests${NC}"
    echo -e "${RED}  7) ğŸ“Š Generate Documentation${NC}"
    echo -e "${RED}  8) ğŸ§¹ Clean Up Ports${NC}"
    echo ""
    echo -e "${WHITE}  0) âŒ Exit${NC}"
    echo ""
    echo -ne "${CYAN}Select option [1-8]: ${NC}"
}

# Find available port
find_available_port() {
    for port in {3000..3010}; do
        if ! lsof -i :$port &> /dev/null; then
            echo $port
            return
        fi
    done
    
    for port in {8000..8010}; do
        if ! lsof -i :$port &> /dev/null; then
            echo $port
            return
        fi
    done
    
    echo "No available port found"
}

# Start server function
start_server() {
    local server_file=$1
    local server_name=$2
    local port_color=$3
    
    echo -e "\n${port_color}ğŸš€ Starting $server_name...${NC}"
    
    # Check if file exists
    if [[ ! -f "$server_file" ]]; then
        echo -e "${RED}âŒ Server file not found: $server_file${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    # Find available port
    local port=$(find_available_port)
    if [[ "$port" == "No available port found" ]]; then
        echo -e "${RED}âŒ No available ports${NC}"
        read -p "Press Enter to continue..."
        return
    fi
    
    echo -e "${GREEN}âœ… Port found: $port${NC}"
    echo -e "${CYAN}ğŸŒ Opening browser...${NC}"
    
    # Open browser in background
    (sleep 2 && open "http://localhost:$port") &
    
    # Start server
    echo -e "${YELLOW}â³ Starting server...${NC}"
    echo -e "${CYAN}ğŸ“Š Dashboard: http://localhost:$port${NC}"
    echo -e "${CYAN}ğŸ“– Documentation: http://localhost:$port/docs${NC}"
    echo ""
    echo -e "${YELLOW}Press Ctrl+C to stop the server${NC}"
    echo ""
    
    # Run server
    if BUN_PORT=$port bun "$server_file"; then
        echo -e "\n${GREEN}âœ… Server stopped successfully${NC}"
    else
        echo -e "\n${RED}âŒ Server encountered an error${NC}"
    fi
    
    read -p "Press Enter to continue..."
}

# Run tests
run_tests() {
    echo -e "\n${RED}ğŸ§ª Running All Tests...${NC}"
    echo ""
    
    # Security test
    echo -e "${BLUE}ğŸ”’ Running Security Tests...${NC}"
    if bun security-test.js; then
        echo -e "${GREEN}âœ… Security tests passed${NC}"
    else
        echo -e "${RED}âŒ Security tests failed${NC}"
    fi
    
    # WebSocket test
    echo -e "${BLUE}ğŸ”Œ Running WebSocket Tests...${NC}"
    if bun websocket-test.js; then
        echo -e "${GREEN}âœ… WebSocket tests passed${NC}"
    else
        echo -e "${RED}âŒ WebSocket tests failed${NC}"
    fi
    
    # API test
    echo -e "${BLUE}ğŸ“¡ Running API Tests...${NC}"
    if bun fetch-example.js; then
        echo -e "${GREEN}âœ… API tests passed${NC}"
    else
        echo -e "${RED}âŒ API tests failed${NC}"
    fi
    
    echo ""
    echo -e "${GREEN}ğŸ‰ All tests completed!${NC}"
    read -p "Press Enter to continue..."
}

# Generate documentation
generate_docs() {
    echo -e "\n${RED}ğŸ“Š Generating Documentation...${NC}"
    echo ""
    
    # Generate file metadata
    echo -e "${BLUE}ğŸ“ Generating file metadata...${NC}"
    ./file-metadata.sh
    echo -e "${GREEN}âœ… File metadata generated${NC}"
    
    # Generate file index
    echo -e "${BLUE}ğŸ“‹ Generating file index...${NC}"
    cat FILE_INDEX.md
    echo -e "${GREEN}âœ… File index ready${NC}"
    
    echo ""
    echo -e "${GREEN}ğŸ“š Documentation generated successfully!${NC}"
    echo -e "${CYAN}ğŸ“– View README.md for complete documentation${NC}"
    read -p "Press Enter to continue..."
}

# Clean up ports
cleanup_ports() {
    echo -e "\n${RED}ğŸ§¹ Cleaning up ports...${NC}"
    echo ""
    
    # Kill any remaining bun processes
    echo -e "${BLUE}ğŸ”„ Stopping remaining processes...${NC}"
    pkill -f "bun.*server" 2>/dev/null
    pkill -f "node.*server" 2>/dev/null
    
    # Wait a moment
    sleep 2
    
    echo -e "${GREEN}âœ… Cleanup complete${NC}"
    echo -e "${CYAN}ğŸš€ Ports are now available for use${NC}"
    read -p "Press Enter to continue..."
}

# Main loop
main() {
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                start_server "server-ultimate.js" "Ultimate Server" "${GREEN}"
                ;;
            2)
                start_server "server-enterprise.js" "Enterprise Server" "${BLUE}"
                ;;
            3)
                start_server "server-secure.js" "Secure Server" "${PURPLE}"
                ;;
            4)
                start_server "server.js" "Full Server" "${YELLOW}"
                ;;
            5)
                start_server "demo-server.js" "Demo Server" "${CYAN}"
                ;;
            6)
                run_tests
                ;;
            7)
                generate_docs
                ;;
            8)
                cleanup_ports
                ;;
            0)
                echo -e "\n${GREEN}ğŸ‘‹ Thank you for using @DEMO Enterprise Platform!${NC}"
                exit 0
                ;;
            *)
                echo -e "\n${RED}âŒ Invalid option. Please choose 1-8 or 0.${NC}"
                sleep 2
                ;;
        esac
    done
}

# Handle Ctrl+C
trap 'echo -e "\n${YELLOW}ğŸ‘‹ Exiting launcher...${NC}"; exit 0' INT

# Start the launcher
main
