#!/bin/bash

# @DEMO Ultimate Enterprise Platform - macOS Application
# Complete integration of AI, Blockchain, Quantum Computing, and AR/VR

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APP_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$(dirname "$APP_DIR")"

# Change to project directory
cd "$PROJECT_DIR"

# Set up colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Print banner
echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${CYAN}â•‘                    ðŸš€ @DEMO ULTIMATE PLATFORM                   â•‘${NC}"
echo -e "${CYAN}â•‘              AI â€¢ Blockchain â€¢ Quantum â€¢ AR/VR â€¢ Security       â•‘${NC}"
echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Check dependencies
check_dependencies() {
    echo -e "${BLUE}ðŸ” Checking dependencies...${NC}"
    
    if ! command -v bun &> /dev/null; then
        echo -e "${RED}âŒ Bun is not installed${NC}"
        osascript -e 'display dialog "Bun is required but not installed. Please install Bun from https://bun.sh" buttons {"OK"} default button "OK" with icon stop'
        exit 1
    fi
    
    echo -e "${GREEN}âœ… Bun installed: $(bun --version)${NC}"
    
    # Check if all required files exist
    local required_files=(
        "server-ultimate.js"
        "ai-analytics.js"
        "blockchain-integration.js"
        "quantum-computing.js"
        "ar-vr-integration.js"
        "advanced-features.js"
        "security-middleware.js"
    )
    
    for file in "${required_files[@]}"; do
        if [[ ! -f "$file" ]]; then
            echo -e "${RED}âŒ Missing required file: $file${NC}"
            exit 1
        fi
    done
    
    echo -e "${GREEN}âœ… All required files present${NC}"
}

# Find available port
find_available_port() {
    echo -e "${BLUE}ðŸ” Finding available port...${NC}"
    
    for port in {3000..3010}; do
        if ! lsof -i :$port &> /dev/null; then
            echo $port
            return
        fi
    done
    
    # Try higher range
    for port in {8000..8010}; do
        if ! lsof -i :$port &> /dev/null; then
            echo $port
            return
        fi
    done
    
    echo -e "${RED}âŒ No available port found${NC}"
    osascript -e 'display dialog "No available ports found. Please close some applications and try again." buttons {"OK"} default button "OK" with icon stop'
    exit 1
}

# Initialize systems
initialize_systems() {
    echo -e "${PURPLE}ðŸ¤– Initializing AI Analytics...${NC}"
    echo -e "${PURPLE}ðŸ”— Initializing Blockchain...${NC}"
    echo -e "${PURPLE}âš›ï¸ Initializing Quantum Computing...${NC}"
    echo -e "${PURPLE}ðŸ¥½ Initializing AR/VR Systems...${NC}"
    echo -e "${PURPLE}ðŸ”’ Initializing Security Framework...${NC}"
    echo ""
}

# Start server with monitoring
start_server() {
    local port=$1
    
    echo -e "${GREEN}ðŸš€ Starting @DEMO Ultimate Platform...${NC}"
    echo -e "${CYAN}ðŸ“Š Dashboard: http://localhost:$port${NC}"
    echo -e "${CYAN}ðŸ¤– AI Analytics: http://localhost:$port/api/analytics${NC}"
    echo -e "${CYAN}ðŸ”— Blockchain: http://localhost:$port/api/blockchain/info${NC}"
    echo -e "${CYAN}âš›ï¸ Quantum: http://localhost:$port/api/quantum/bell${NC}"
    echo -e "${CYAN}ðŸ¥½ AR/VR: http://localhost:$port/api/arvr/handtracking${NC}"
    echo -e "${CYAN}ðŸ”Œ WebSocket: ws://localhost:$port/ws${NC}"
    echo -e "${CYAN}ðŸ“– Documentation: http://localhost:$port/docs${NC}"
    echo ""
    
    # Create loading indicator
    echo -e "${YELLOW}â³ Systems starting up...${NC}"
    
    # Open browser after a short delay
    (sleep 3 && open "http://localhost:$port") &
    
    # Start the ultimate server
    echo -e "${GREEN}âœ¨ Server starting on port $port${NC}"
    echo ""
    
    # Run with error handling
    if BUN_PORT=$port bun server-ultimate.js; then
        echo -e "${GREEN}âœ… Server started successfully${NC}"
    else
        echo -e "${RED}âŒ Failed to start server${NC}"
        osascript -e 'display dialog "Failed to start @DEMO server. Please check the console for details." buttons {"OK"} default button "OK" with icon stop'
        exit 1
    fi
}

# Show system status
show_status() {
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${CYAN}                    ðŸŽ¯ SYSTEM STATUS                           ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… AI Analytics: Neural Networks Active${NC}"
    echo -e "${GREEN}âœ… Blockchain: Distributed Ledger Ready${NC}"
    echo -e "${GREEN}âœ… Quantum Computing: Simulators Online${NC}"
    echo -e "${GREEN}âœ… AR/VR: Spatial Computing Enabled${NC}"
    echo -e "${GREEN}âœ… Security: Multi-Layer Protection Active${NC}"
    echo -e "${GREEN}âœ… Real-time: WebSocket Connection Ready${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

# Main execution
main() {
    # Check dependencies
    check_dependencies
    echo ""
    
    # Find available port
    AVAILABLE_PORT=$(find_available_port)
    echo -e "${GREEN}âœ… Available port found: $AVAILABLE_PORT${NC}"
    echo ""
    
    # Initialize systems
    initialize_systems
    
    # Show status
    show_status
    
    # Start server
    start_server $AVAILABLE_PORT
}

# Handle cleanup
cleanup() {
    echo ""
    echo -e "${YELLOW}ðŸ›‘ Shutting down @DEMO Ultimate Platform...${NC}"
    
    # Kill any remaining processes
    pkill -f "server-ultimate.js" 2>/dev/null
    pkill -f "blockchain" 2>/dev/null
    
    echo -e "${GREEN}âœ… Cleanup complete${NC}"
    
    # Show final dialog
    osascript -e 'display dialog "@DEMO Ultimate Platform has been shut down. Thank you for using our enterprise solution!" buttons {"OK"} default button "OK" with icon note'
}

# Set up signal handlers
trap cleanup EXIT INT TERM

# Run main function
main "$@"
